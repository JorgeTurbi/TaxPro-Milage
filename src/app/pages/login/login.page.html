<ion-content [fullscreen]="true">

    <!-- ======== PANTALLA DE SELECCIÓN DE COMPANY ======== -->
    @if (showCompanySelection) {
    <div class="login-container fade-in">

        <!-- Logo -->
        <div>
            <img src="../../../assets/logo/taxpro-millage.png" alt="TaxPro Suite" />
        </div>

        <div class="company-selection-card">

            <!-- Header con botón de volver -->
            <div class="company-header">
                <div class="company-back-btn" (click)="backToLogin()">
                    <ion-icon name="arrow-back-outline"></ion-icon>
                </div>
                <div>
                    <p class="company-title">Selecciona tu compañía</p>
                    <p class="company-subtitle">Elige la compañía con la que deseas iniciar sesión</p>
                </div>
            </div>

            <!-- Error -->
            @if (errorMessage) {
            <div class="error-banner">
                <ion-icon name="alert-circle-outline"></ion-icon>
                <span>{{ errorMessage }}</span>
            </div>
            }

            <!-- Lista de compañías -->
            <div class="company-list">
                @for (company of availableCompanies; track company.companyId) {
                <div class="company-card" (click)="selectCompany(company)" [class.disabled]="isLoading">

                    <!-- Logo o placeholder -->
                    <div class="company-logo-wrapper">
                        @if (company.companyLogo) {
                        <img [src]="company.companyLogo" [alt]="company.companyName" class="company-logo" />
                        } @else {
                        <div class="company-logo-placeholder">
                            <span>{{ getCompanyInitials(company.companyName) }}</span>
                        </div>
                        }
                    </div>

                    <!-- Info -->
                    <div class="company-info">
                        <p class="company-name">{{ company.companyName }}</p>
                        @if (company.companyCity || company.companyState) {
                        <p class="company-location">
                            <ion-icon name="location-outline"></ion-icon>
                            {{ company.companyCity }}@if (company.companyCity && company.companyState) {, }{{ company.companyState }}
                        </p>
                        }
                        @if (company.displayName) {
                        <p class="company-user">{{ company.displayName }}</p>
                        }
                    </div>

                    <!-- Loading indicator por card -->
                    @if (isLoading) {
                    <ion-spinner name="crescent" class="company-spinner"></ion-spinner>
                    }
                </div>
                }
            </div>

        </div>

        <p class="version-text">v1.0.0</p>
    </div>
    }

    <!-- ======== PANTALLA DE LOGIN ======== -->
    @else {
    <div class="login-container">

        <!-- Logo de TaxPro Suite -->
        <div>
            <img src="../../../assets/logo/taxpro-millage.png" alt="TaxPro Suite" />
        </div>

        <!-- Tarjeta de Login -->
        <div class="login-card fade-in">

            <!-- Título -->
            <p class="login-subtitle">Inicia sesión para continuar</p>

            <!-- Formulario de Login -->
            <form [formGroup]="loginForm" (ngSubmit)="onSubmit()">

                <!-- Campo Email -->
                <ion-input class="taxpro-input" type="email" formControlName="email" placeholder="Correo electrónico"
                    [clearInput]="true" autocomplete="email">
                    <ion-icon slot="start" name="mail-outline"></ion-icon>
                </ion-input>

                <!-- Error de Email -->
                @if (loginForm.get('email')?.touched && loginForm.get('email')?.errors) {
                <p class="error-text">
                    @if (loginForm.get('email')?.errors?.['required']) {
                    El correo es requerido
                    }
                    @if (loginForm.get('email')?.errors?.['email']) {
                    Ingresa un correo válido
                    }
                </p>
                }

                <!-- Campo Contraseña -->
                <ion-input class="taxpro-input" type="password" formControlName="password" placeholder="Contraseña"
                    autocomplete="current-password">
                    <ion-icon slot="start" name="lock-closed-outline"></ion-icon>
                    <ion-input-password-toggle slot="end"></ion-input-password-toggle>
                </ion-input>

                <!-- Error de Contraseña -->
                @if (loginForm.get('password')?.touched && loginForm.get('password')?.errors) {
                <p class="error-text">
                    @if (loginForm.get('password')?.errors?.['required']) {
                    La contraseña es requerida
                    }
                    @if (loginForm.get('password')?.errors?.['minlength']) {
                    Mínimo 6 caracteres
                    }
                </p>
                }

                <!-- Error General -->
                @if (errorMessage) {
                <div class="error-banner">
                    <ion-icon name="alert-circle-outline"></ion-icon>
                    <span>{{ errorMessage }}</span>
                </div>
                }

                <!-- Botón de Login -->
                <ion-button expand="block" type="submit" class="btn-taxpro" [disabled]="isLoading || loginForm.invalid">
                    @if (isLoading) {
                    <ion-spinner name="crescent"></ion-spinner>
                    } @else {
                    <ion-icon slot="start" name="log-in-outline"></ion-icon>
                    Iniciar Sesión
                    }
                </ion-button>

            </form>

            <!-- Separador -->
            @if (biometryAvailable) {
            <div class="separator">
                <span>o</span>
            </div>

            <!-- Botón de Biometría -->
            <div class="biometric-btn" (click)="loginWithBiometrics()">
                <ion-icon name="finger-print"></ion-icon>
                <span>{{ biometryType === 'faceId' ? 'Usar Face ID' : 'Usar huella digital' }}</span>
            </div>
            }

        </div>

        <!-- Versión de la app -->
        <p class="version-text">v1.0.0</p>

    </div>
    }

</ion-content>
